name: Chocolatey Push

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  chocolatey:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Pack and Push Packages
        env:
          CHOCO_API_KEY: ${{ secrets.CHOCO_API_KEY }}
        shell: powershell
        run: |
          $packageFolders = @("TreeSheets", "Sigil", "Gmail-Growl", "System-Monitor")
          $eventName = "${{ github.event_name }}"
          $before = "${{ github.event.before }}"
          $sha = "${{ github.sha }}"

          Write-Host "Event Name: $eventName"

          $processAll = $false
          $changedFiles = @()

          if ($eventName -eq "push") {
             Write-Host "Push event detected. Before: $before, After: $sha"

             if ([string]::IsNullOrWhiteSpace($before) -or $before -match "^0+$") {
                 # New branch or something where before is not set correctly
                 Write-Host "Before commit is empty or zero. Trying to compare against HEAD~1..."
                 try {
                     $changedFiles = git diff --name-only HEAD~1 HEAD
                 } catch {
                     Write-Warning "Git diff failed. Processing all packages."
                     $processAll = $true
                 }
             } else {
                 # Standard push range
                 # Note: If forced push, this might fail if 'before' is unreachable.
                 # We capture stderr to avoid failing the step immediately if we want to fallback?
                 # PowerShell by default continues on external command failure unless $ErrorActionPreference is Stop.
                 $changedFiles = git diff --name-only $before $sha 2>&1
                 if ($LASTEXITCODE -ne 0) {
                     Write-Warning "Git diff failed (exit code $LASTEXITCODE). Processing all packages."
                     $processAll = $true
                 }
             }
          } else {
             Write-Host "Not a push event. Processing all packages."
             $processAll = $true
          }

          if (-not $processAll) {
              Write-Host "Changed files:"
              if ($changedFiles) {
                  $changedFiles | ForEach-Object { Write-Host "  - $_" }
              } else {
                  Write-Host "  (None)"
              }
          }

          foreach ($folder in $packageFolders) {
            if (-not $processAll) {
                $hasChanges = $false
                if ($changedFiles) {
                    foreach ($file in $changedFiles) {
                        # git diff returns paths with forward slashes
                        if ($file -match "^$folder/") {
                            $hasChanges = $true
                            break
                        }
                    }
                }

                if (-not $hasChanges) {
                    Write-Host "Skipping $folder (no changes detected)"
                    continue
                }
            }

            Write-Host "--------------------------------------------------"
            Write-Host "Processing folder: $folder"

            # Clean up previous nupkgs to avoid confusion
            Remove-Item *.nupkg -ErrorAction SilentlyContinue

            # Find nuspec in the folder
            $nuspec = Get-ChildItem -Path $folder -Filter *.nuspec | Select-Object -First 1

            if ($nuspec) {
                Write-Host "Found nuspec: $($nuspec.FullName)"

                # Pack
                choco pack $nuspec.FullName
                if ($LASTEXITCODE -ne 0) {
                    Write-Error "Failed to pack $($nuspec.FullName)"
                    continue
                }

                # Find the generated nupkg
                $nupkg = Get-ChildItem -Filter *.nupkg | Select-Object -First 1

                if ($nupkg) {
                    Write-Host "Generated nupkg: $($nupkg.Name)"

                    if ($env:CHOCO_API_KEY) {
                        Write-Host "Pushing to Chocolatey..."
                        choco push $nupkg.FullName --source https://push.chocolatey.org/ --api-key $env:CHOCO_API_KEY

                        if ($LASTEXITCODE -eq 0) {
                            Write-Host "Successfully pushed $($nupkg.Name)"
                        } elseif ($LASTEXITCODE -eq 1) {
                             # Exit code 1 usually means validation failure or generic error.
                             # Chocolatey sometimes returns 1 if package already exists (depending on version).
                             # We'll verify output in logs.
                             Write-Warning "Failed to push $($nupkg.Name). Check logs for details (e.g., version already exists)."
                        } else {
                             Write-Warning "Failed to push $($nupkg.Name) with exit code $LASTEXITCODE."
                        }
                    } else {
                        Write-Warning "CHOCO_API_KEY secret is not set. Skipping push."
                    }
                } else {
                    Write-Error "No nupkg generated for $folder"
                }
            } else {
                Write-Warning "No nuspec file found in $folder"
            }
          }
